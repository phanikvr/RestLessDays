// 
// Core Javascript File that Runs All Games.
//
// NOTE: The following Notation is needed in ALL Javascript files
//       that run Jquery commands:
//       $(function() {
//         ...
//       });
//

//ALERT: You have to put global variables outside of Jquery Tags for them to work.

/* Cool Code to be tested */
/*
$('#canvas_set').fadeOut(2000);
*/

// The Main Canvas character and 2D Context variable
var canvas, ctx;
// Array that holds Every Key that has been pressed in the recording process.
var keys_pressed = [];
// Incrementer for the keys_pressed array.
var i = 0;
// Global Time to store the Time that goes by during the animation.
var global_time = 0;
// The "Cliff" character character.
var cliff;
// The "Mimi" character character.
var mimi;
// The "Roy" character character.
var roy;
// Directory that holds character graphics
var dir_chars = './images/chars/';
// Directory that holds scene props/characters (e.g. bed etc.)
var dir_props = './images/props/';
// The Sets/Backgrounds of the show.
var sets;
// The command Prompt
var commandPrompt;
// Maps Char Name to talk command key and 
// Speech Bubble Number Id.
// 
var char_talk_key_sb = [];
char_talk_key_sb['roy'] = [];
char_talk_key_sb['roy']['talk_key'] = 86;
char_talk_key_sb['roy']['sb_no'] = 2;
char_talk_key_sb['cliff'] = [];
char_talk_key_sb['cliff']['talk_key'] = 18;
char_talk_key_sb['cliff']['sb_no'] = 1;  
char_talk_key_sb['mimi'] = [];
char_talk_key_sb['mimi']['talk_key'] = 9;
char_talk_key_sb['mimi']['sb_no'] = 3;  

// The Current Talk Command Key from action array.
var current_talk_key = 0;
// The Current Dialogue Number of the Episode.
var dg_no = 1;
 
function simulateKeyPress(key,time) {

  /* 
  Dialogue Functionality must be in this Key Press function
  because it must be in sync with action key.
  */
  sb_no = 0;
  for (var i in char_talk_key_sb) {
    if(key == char_talk_key_sb[i]['talk_key']) {
      char_name = i;
      sb_no = char_talk_key_sb[i]['sb_no']; 
      break;
    }
  }

  if(sb_no) {
    if(key != current_talk_key) {
      //alert(dg_no + ':' + key);
      current_talk_key = key;
      $('.sb').css('display','none');
      line = dialogue[1][dg_no][char_name];
      sb_html = '<b>' + ucwords(char_name) + '</b>: ' + line;
      $('#speech_bubble_' + sb_no + 'a').html(sb_html);
      $("[id^='speech_bubble_" + sb_no + "']").css('display','block');
      dg_no++;  
    }
  } else {
    $('.sb').css('display','none');
    current_talk_key = 0;
  }
  

  /*
  //DEBUG - OFF
  if(vars['line'] != undefined) {
    $('#speech_bubble_' + vars['sb_no'] + 'a').html(vars['sb_html']);
    $("[id^='speech_bubble_" + vars['sb_no'] + "']").css('display','block');
  }
  */

  e = jQuery.Event("keydown");
  e.which = key;
  e.keyCode = key;
  // Canvas character
  $("#canvas_set").trigger(e);

  /* Dialogue Functionality has to be real time. */

}


/* OLD CODE: Channels Content */
/*
function channelOff() {
}
function channel1Content() {
}
function channel2Content() {
}
function channel3Content() {  
}
*/

function ucwords(str) {
    return (str + '').replace(/^([a-z])|\s+([a-z])/g, function ($1) {
        return $1.toUpperCase();
    });
}

/* CLASS: commandPrompt */
function commandPrompt() {
  // The allowed Commands of the Command Prompt
  this.commands = ['play the restless days 1','instructions','show statistics','add comment x'];
}
/* */
commandPrompt.prototype.start = function() { 
  //$('#power_button').val('Return to prompt>');
  $('#power_button').css('visibility','hidden');
  $('#channel_off').css('display','none');
  $('#command_prompt').css('display','block');
  $('#command_prompt div').css('display','block');
  $('#prompt').focus();
  return true;
}
commandPrompt.prototype.commandFound = function(command) { 
  if($.inArray(command.toLowerCase(), this.commands) == -1 ) {
    return false;
  }
  return true;
}

/* CLASS: character */
function character(name, type, x, y, w, h, image_state) {
  this.x = x;
  this.y = y;
  this.w = w;
  this.h = h;
  this.name = name;
  this.img = '';
  this.clothing = 'default';
  this.image_state = image_state;
  this.img = new Image();
  this.props = [];
  
  if(type == 'character') {
    this.img.src = dir_chars + this.name + '/' + this.clothing + '/' + this.image_state + '.png';
  }
  if(type == 'prop') {
    this.img.src = dir_props + '/' + this.image_state + '.png';
  }
}
character.prototype.drawImage = function() {
  ctx.drawImage(this.img, this.x, this.y, this.w, this.h);	
}
character.prototype.charCommands = function(ctx, config) {  
  
  $.each(config, function( command, params ) {
    str = "this."+ command + "(ctx";
    if(params.length) {
      str += "," + params.join(",");
    }
    str += ");";
  });
  eval(str);
}
character.prototype.move = function(ctx, direction){
  
  var stationary = 0;  
  ctx.clearRect(this.x,this.y,this.w,this.h);
  
  if(['left','right'].indexOf(direction) != -1) { 
			    
    if(direction == 'left') {		  
	    if(this.image_state.indexOf('right') == -1) {
	      this.image_state = 'right-standing-mouth-closed';
	      stationary = 1;
	    } else {
	      if(this.image_state.indexOf('right-walking-left-foot') == -1) {
	        this.image_state = 'right-walking-left-foot';
	      } else {
	        this.image_state = 'right-walking-right-foot';
	      }
	    }
	    op = "-";
	  }	  
    if(direction == 'right') {
      if(this.image_state.indexOf('left') == -1) {
        this.image_state = 'left-standing-mouth-closed';
        stationary = 1;
      } else {
        if(this.image_state.indexOf('left-walking-left-foot') == -1) {
          this.image_state = 'left-walking-left-foot';
        } else {
          this.image_state = 'left-walking-right-foot';
        }
      }
      op = "+";
    }
	  	   
    if (!stationary) {
      eval("this.x = this.x " + op + " 10");
    }
	
  } else if(['up','down'].indexOf(direction) != -1) {
    	  
    op = "+";
    if(direction == 'up') {
      if(this.image_state.indexOf('back') == -1) {
        this.image_state = 'back-standing';
        stationary = 1;
      } else {
        if(this.image_state.indexOf('back-walking-left-foot') == -1) {
          this.image_state = 'back-walking-left-foot';
        } else {
          this.image_state = 'back-walking-right-foot';
        }
      }
      op = "-";
    }
    if(direction == 'down') { 
      if(this.image_state.indexOf('front') == -1) {
        this.image_state = 'front-standing-mouth-closed';
        stationary = 1;
      } else {
        if(this.image_state.indexOf('front-walking-right-foot') == -1) {
          this.image_state = 'front-walking-right-foot';
        } else {
          this.image_state = 'front-walking-left-foot';
        }
      }
      op = "+";
    }
    
	  if (!stationary) {
	    eval("this.y = this.y " + op + " 10");
	  }
	}
 
	this.draw(ctx);
  
}
character.prototype.talk = function(ctx) {
  ctx.clearRect(this.x,this.y,this.w,this.h);
	
  pos1 = 'front';
  pos2 = 'standing';

  if(this.image_state.indexOf('front') != -1  ||
     this.image_state.indexOf('left') != -1  ||
	 this.image_state.indexOf('right') != -1) {	
    pos1 = this.image_state.split('-')[0];
    pos2 = this.image_state.split('-')[1];    
    if(pos2 != 'sitting') {
      pos2 = 'standing';
    }
  }
      
  if(this.image_state.indexOf('-mouth-closed') == -1) {
    this.image_state = pos1 + '-' + pos2 + '-mouth-closed';  
  } else {
    this.image_state = pos1 + '-' + pos2 + '-mouth-open';	  
  }
  
  this.renderAttachedProps(ctx);
  
  this.draw(ctx);
  
  ctx.globalCompositeOperation = 'source-over';
  
}
character.prototype.sit = function(ctx) {
  if(this.image_state.indexOf('left-standing') != -1  ||
	 this.image_state.indexOf('left-walking') != -1   ||
	 this.image_state.indexOf('right-standing') != -1 ||
	 this.image_state.indexOf('right-walking') != -1) {
	  
    ctx.clearRect(this.x,this.y,this.w,this.h);
        
    if(this.image_state.indexOf('left-standing') != -1 ||
      this.image_state.indexOf('left-walking') != -1) {
      this.image_state = 'left-sitting-mouth-closed';
    } else {
      this.image_state = 'right-sitting-mouth-closed';
    }
		
    this.draw(ctx);
  }
}
character.prototype.renderAttachedProps = function(ctx) {
  if(this.props.length) {
    $.each(this.props, function(index, prop) {
      // TEST IMG-OVER-IMG
      ctx.globalCompositeOperation = 'destination-over';
      ctx.clearRect(prop.x,prop.y,prop.w,prop.h);
      prop.drawImage();
    });
  }
  
}
character.prototype.draw = function(ctx) {
  this.changeImgSrc();
  ctx.drawImage(this.img, this.x, this.y, this.w, this.h);
} 
character.prototype.changeImgSrc = function() {
  //global_time += delay;	
  //setTimeout(function () {  
  this.img.src = dir_chars + this.name + '/' + this.clothing + '/' + this.image_state + '.png';
  //}, global_time);
}

function firstScene() {
  //Calling this first before drawing characters solves the 
  //"[refresh] dissapearing canvas" problem.
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // SMOOTH LINES - ON/OFF
  ctx.mozImageSmoothingEnabled = false;
  
  mimi = new character('mimi', 'character', 308, -120, 80, 114, 'front-standing-mouth-closed');
  mimi.drawImage();
  
  roy = new character('roy', 'character', 308, -120, 80, 114, 'front-standing-mouth-closed');
  roy.drawImage();
  
  ctx.globalCompositeOperation = 'destination-over';
  
  bed = new character('bed', 'prop', 77, 349, 145, 112, 'hospital-bed-light-blue-blanket');
  bed.drawImage();
  
  cliff = new character('cliff', 'character', 75, 321, 80, 114, 'left-standing-mouth-closed');
  cliff.props.push(bed);
  cliff.drawImage();
 
}
$(document).ready(function() {

  //Create a Command Prompt
  commandPrompt = new commandPrompt();
  
  if(document.location == 'http://dev.filmtronic.com/the-restless-days/?payment=success' ||
    document.location == 'http://www.filmtronic.com/the-restless-days/?payment=success') {
    commandPrompt.start();
  } else if(document.location == 'http://dev.filmtronic.com/the-restless-days/?payment=cancelled' ||
    document.location == 'http://www.filmtronic.com/the-restless-days/?payment=cancelled') {
    $('#power_button').val('Try Again');
  }
  	
  // FORMAT is MP3 for now on.
  // Review Sound File Below (could be too funny with dialogue)
  // sound_file = './sounds/2009-dietmarhess-excl-show_beats_01_proud_music_preview';
  sound_file = './sounds/on_the_town_proud_music_preview';
  var episode1Sound = new buzz.sound( sound_file, {
    formats: [ "mp3" ],
    volume: 100
  });
    
  /* Create the Canvas character */
  canvas = document.getElementById('canvas_set');
  /* Set the 2D Context */
  ctx = canvas.getContext("2d");

  /* SCALE the Context 
  The 0.04 was added as they Eyes of the characters were too small with 
  scale(0.8,0.8);
  */
  ctx.scale(0.84,0.84);
  
  canvas.addEventListener("click", doMouseDown, false);
  
  /* Sets/Backgrounds of Show */
  sets = [];
  sets[0] = './images/sets/hospital-private-room.png';
  sets[1] = './images/sets/tv-coloured-lines.png';
  sets[2] = './images/sets/device-green-lines.png';
  
  /*
  *********
  ALERT!!!!!! > global_time affects Episode Sound File Timing with Animation!!!!
  *********
  $('#canvas_set').css('background-image', 'url("' + sets[1] + '")');
  global_time += 4000;
  setTimeout(function(){ $('#canvas_set').css('background-image', 'url("' + sets[0] + '")'); }, global_time);
  */


  //Zoom facility - Work in Progress
  //ctx.save();
  //ctx.translate(-300,-1500);
  //ctx.scale(5,5);
  //ctx.restore();

  /* TV Off Air Screen and Sound */
  $('#canvas_set').css('background-image', 'url("' + sets[1] + '")');

  // Width:420px was used because we had to cater for the 0.84 Scale on Context
  // due to Eye size of character.
  $('#canvas_set').css('background-size', '420px 400px');

  /* ALERT: Speech Bubble example - currently NOT WORKING */
  /*
  ctx.fillStyle = "white";
  ctx.fillRect(0,0, 200, 200);
  // draw font in red
  ctx.fillStyle = "red";
  ctx.font = "20pt sans-serif";
  ctx.fillText("Canvas Rocks!", 5, 100);
  ctx.strokeText("Canvas Rocks!", 5, 130);
  */
  
  global_time += 3000;
  setTimeout(function(){ 
    $('#canvas_set').css('background-image', 'url("' + sets[0] + '")');
    firstScene(); 
  }, global_time);

  /*
  global_time += 6000;
  setTimeout(function(){ 
    canvas.width = canvas.width;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    $('#canvas_set').hide();
    $('#canvas_set').show();
    $('#canvas_set').css('background-image', 'url("' + sets[2] + '")'); 
  }, global_time);
  */

  
  $('#record').click(function(){    
    if($(this).val() == 'RECORD') {
      keys_pressed = [];
      i = 0;
      firstScene();
      $(this).val('STOP RECORDING');
    } else {
      firstScene();
      $(this).val('RECORD');
      // Save the below to a js file.
      prompt('Recorded Episode Actions JSON Array:', JSON.stringify(keys_pressed));
    }
  });

  $('#channel_plus').click(function(){

    new_no = parseInt($('#channel_number').html()) + 1
    
    if(new_no < 4 && new_no > 0) {
      $('#channel_number').html(new_no);
    }

    if(new_no == 2) {
      canvas.width = canvas.width;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      $('#canvas_set').css('background', 'url("' + sets[2] + '") top left no-repeat');
      
      setTimeout(function(){  
        $('#channel_1').css('display','none');
        $('#channel_2').css('display','block');
      }, 2000);
    }

    if(new_no == 3) {
      canvas.width = canvas.width;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      $('#channel_2').css('display','none');
      $('#channel_1').css('display','none');
      $('#channel_3').css('display','block');
      $('#channel_3 div').css('display', 'none');
      $('#channel_3').css('background', 'url("' + sets[2] + '") top left no-repeat');

      setTimeout(function(){
        $('#channel_3').css('background-image', 'none'); 
        $('#channel_3 div').css('display', 'block');
      }, 2000);
    }


  });

  $('#channel_minus').click(function(){
    new_no = parseInt($('#channel_number').html()) - 1
    
    if(new_no < 4 && new_no > 0) {
      $('#channel_number').html(new_no);
    }
  });

  $('#power_button').click(function(){

    if($(this).val() == 'PayPal $1 to Play' ||
       $(this).val() == 'Try Again') {
      $(this).val('Going to PayPal');
      setTimeout(function(){ $('#power_button').val('Going to PayPal.'); }, 0);
      setTimeout(function(){ $('#power_button').val('Going to PayPal..'); }, 500);
      setTimeout(function(){ $('#power_button').val('Going to PayPal...'); }, 600);
      $('#paypal_form').submit();
      //$('#command_prompt').css('background', 'url("' + sets[2] + '") top left no-repeat');
      //setTimeout(function(){
      //$('#command_prompt').css('background','none');
      //$('#command_prompt').css('background-color','#11230E');
      //}, 1000);
      /*
      $('#channel_off').css('display','none');
      $('#gui').fadeIn(2000);
      $(this).val('OFF');
      */
    } else {
      $(this).css('visibility','hidden');
      //$(this).val('PayPal $1 to play');
      //episode1Sound.pause();
      //firstScene();
      //$('#channel_off').css('display','block');
      //$('#gui').css('display','none');
      //$('#command_prompt').css('display','none');      
    }

  });

  //$('#play_back').css('display','none');
  
  $('#play_back').click(function(){
    
    if($(this).val() == 'PLAY') {
      $(this).val('STOP');
      
      /* Initialise Show - InitConfig */
      // ALERT: This is problematic because coming from the "Comments" section
      // Creates a Scale problem.
      /*
      scaleWidth = canvas.width/100;
      scaleHeight = canvas.height/100;
      alert(scaleWidth);
      */
      //ctx.scale(0.84,0.84);
      
      $('#command_prompt').css('display','none');
      $('#gui').css('display','block');
      episode1Sound.load();
      $('#canvas_set').css('background-image', 'url("' + sets[0] + '")');
      firstScene();  
      
      //DEBUG
      episode1Sound.play();

      //alert(JSON.stringify(keys_pressed));
      //SAVED FIRST EPISODE COMMANDS
      //These keys_pressed work with sound_file = './sounds/episode01-part2.mp3'; 
      //keys_pressed = [[1445148869395,72],[1445148869539,72],[1445148869683,72],[1445148869828,72],[1445148869963,72],[1445148870108,72],[1445148870258,72],[1445148870402,72],[1445148870538,72],[1445148870690,72],[1445148870835,72],[1445148870962,72],[1445148871098,72],[1445148871243,72],[1445148871386,72],[1445148871522,72],[1445148871759,72],[1445148871794,72],[1445148871938,72],[1445148872090,72],[1445148872234,72],[1445148872372,72],[1445148872522,72],[1445148872666,72],[1445148872810,72],[1445148872964,72],[1445148873108,72],[1445148873250,72],[1445148873402,72],[1445148873546,72],[1445148873698,72],[1445148873846,72],[1445148874002,72],[1445148874066,71],[1445148874194,71],[1445148874346,71],[1445148874490,71],[1445148874618,71],[1445148874794,72],[1445148874938,72],[1445148875058,72],[1445148875202,72],[1445148875346,72],[1445148875482,72],[1445148875642,72],[1445148875794,72],[1445148875938,72],[1445148876090,72],[1445148876234,72],[1445148876450,71],[1445148876626,71],[1445148876770,71],[1445148878338,86],[1445148878579,86],[1445148878879,86],[1445148879120,86],[1445148879202,86],[1445148879394,86],[1445148879602,86],[1445148879802,86],[1445148880002,86],[1445148880169,86],[1445148880362,86],[1445148880529,86],[1445148880994,86],[1445148881681,18],[1445148881865,18],[1445148882025,18],[1445148882201,18],[1445148882393,18],[1445148882777,18],[1445148883530,86],[1445148883841,86],[1445148884097,86],[1445148884313,86],[1445148884505,86],[1445148885017,86],[1445148885241,86],[1445148885457,86],[1445148885649,86],[1445148885818,86],[1445148886481,86],[1445148886713,86],[1445148886913,86],[1445148887297,86],[1445148888177,18],[1445148888393,18],[1445148888577,18],[1445148888969,18],[1445148890025,86],[1445148890297,86],[1445148890505,86],[1445148890713,86],[1445148890897,86],[1445148891113,86],[1445148891881,86],[1445148892137,86],[1445148892466,86],[1445148892985,86],[1445148893417,18],[1445148893593,18],[1445148893761,18],[1445148894105,18],[1445148894713,18],[1445148894881,18],[1445148896305,86],[1445148896545,86],[1445148896809,86],[1445148897057,86],[1445148897977,18],[1445148898160,18],[1445148898337,18],[1445148898504,18],[1445148898672,18],[1445148898840,18],[1445148899008,18],[1445148899176,18],[1445148899321,18],[1445148899752,18],[1445148900152,18],[1445148900336,18],[1445148900512,18],[1445148900680,18],[1445148900857,18],[1445148901040,18],[1445148901216,18],[1445148901408,18],[1445148901592,18],[1445148901760,18],[1445148901920,18],[1445148902120,18],[1445148902320,18],[1445148903112,18],[1445148903328,18],[1445148903504,18],[1445148903680,18],[1445148903832,18],[1445148904008,18],[1445148904200,18],[1445148904384,18],[1445148904824,18],[1445148905488,18],[1445148905680,18],[1445148905904,18],[1445148906120,18],[1445148906320,18],[1445148906520,18],[1445148906704,18],[1445148907112,18],[1445148907880,86],[1445148908144,86],[1445148908376,86],[1445148908584,86],[1445148908784,86],[1445148909304,86],[1445148910056,18],[1445148910240,18],[1445148910416,18],[1445148910856,18],[1445148911048,18],[1445148911232,18],[1445148911448,18],[1445148911632,18],[1445148911864,18],[1445148912032,18],[1445148912392,18],[1445148912584,18],[1445148912751,18],[1445148912912,18],[1445148913056,18],[1445148913240,18],[1445148913424,18],[1445148913856,18],[1445148914264,18],[1445148914448,18],[1445148914776,18],[1445148915024,18],[1445148915247,18],[1445148915415,18],[1445148915591,18],[1445148915799,18],[1445148915992,18],[1445148916199,18],[1445148916415,18],[1445148916615,18],[1445148916791,18],[1445148917047,18],[1445148917976,86],[1445148918215,86],[1445148918416,86],[1445148918624,86],[1445148918873,86],[1445148919320,86],[1445148919815,18],[1445148919983,18],[1445148920175,18],[1445148920343,18],[1445148922471,86],[1445148922743,86],[1445148923408,86],[1445148923616,86],[1445148923799,86],[1445148923975,86],[1445148924167,86],[1445148924351,86],[1445148924599,86],[1445148924991,86],[1445148925287,86],[1445148925535,86],[1445148925720,86],[1445148925903,86],[1445148926087,86],[1445148926287,86],[1445148926687,86],[1445148927407,86],[1445148927679,86],[1445148927896,86],[1445148928103,86],[1445148928295,86],[1445148928503,86],[1445148928703,86],[1445148928903,86],[1445148929111,86],[1445148929984,86],[1445148930287,86],[1445148930559,86],[1445148930783,86],[1445148931007,86],[1445148931231,86],[1445148931455,86],[1445148932087,86],[1445148932591,86],[1445148932927,86],[1445148933214,18],[1445148933519,18],[1445148933710,18],[1445148933926,18],[1445148935375,18],[1445148935567,86],[1445148935871,86],[1445148936071,86],[1445148936279,86],[1445148936503,86],[1445148936727,86],[1445148936943,86],[1445148937143,86],[1445148937351,86],[1445148937582,86],[1445148937807,86],[1445148938007,86],[1445148938199,86],[1445148938406,86],[1445148939758,18],[1445148939974,18],[1445148940190,18],[1445148940750,18],[1445148940974,18],[1445148941174,18],[1445148941374,18],[1445148941574,18],[1445148941774,18],[1445148941966,18],[1445148942174,18],[1445148942366,18],[1445148942982,18],[1445148943182,18],[1445148943374,18],[1445148943542,18],[1445148943734,18],[1445148943942,18],[1445148944150,18],[1445148944334,18],[1445148944526,18],[1445148944718,18],[1445148944918,18],[1445148945102,18],[1445148945294,18],[1445148945911,18],[1445148946110,18],[1445148946302,18],[1445148946454,18],[1445148946606,18],[1445148947174,18],[1445148947750,18],[1445148947942,18],[1445148948134,18],[1445148948310,18],[1445148948510,18],[1445148948710,18],[1445148949886,86],[1445148950302,86],[1445148950590,86],[1445148950870,86],[1445148951974,18],[1445148952309,18],[1445148952726,86],[1445148952990,86],[1445148953206,86],[1445148953414,86],[1445148953645,86],[1445148953830,86],[1445148954734,18],[1445148954949,18],[1445148955133,18],[1445148955309,18],[1445148955501,18],[1445148955701,18],[1445148955877,18],[1445148956021,18],[1445148957102,86],[1445148957366,86],[1445148957574,86],[1445148958206,86],[1445148958309,18],[1445148958485,18],[1445148958653,18],[1445148958829,18],[1445148958989,18],[1445148959149,18],[1445148959549,18],[1445148959781,18],[1445148959941,18],[1445148960093,18],[1445148960495,18],[1445148960693,18],[1445148960861,18],[1445148961029,18],[1445148961197,18],[1445148961349,18],[1445148962933,86],[1445148963189,86],[1445148963398,86],[1445148963581,86],[1445148963805,86],[1445148964021,86],[1445148964805,18],[1445148965237,18],[1445148965789,86],[1445148966029,86],[1445148966213,86],[1445148966461,86],[1445148966837,86],[1445148967085,86],[1445148967285,86],[1445148967525,86],[1445148967757,86],[1445148968037,86],[1445148968333,86],[1445148968565,86],[1445148968773,86],[1445148968957,86],[1445148969157,86],[1445148969557,86],[1445148969965,86],[1445148970173,86],[1445148971117,86],[1445148971381,86],[1445148971653,86],[1445148971877,86],[1445148972125,86],[1445148972645,86],[1445148972877,86],[1445148973085,86],[1445148973357,86],[1445148973741,86],[1445148974573,18],[1445148974837,18],[1445148975068,18],[1445148975292,18],[1445148975500,18],[1445148975708,18],[1445148975877,18],[1445148976076,18],[1445148976796,18],[1445148976996,18],[1445148977180,18],[1445148977364,18],[1445148977532,18],[1445148978308,18],[1445148978908,18],[1445148979108,18],[1445148979316,18],[1445148979516,18],[1445148979700,18],[1445148979908,18],[1445148980100,18],[1445148980308,18],[1445148980524,18],[1445148980788,18],[1445148981020,18],[1445148981196,18],[1445148981372,18],[1445148981548,18],[1445148982660,18],[1445148982868,18],[1445148983044,18],[1445148983204,18],[1445148985116,86],[1445148985380,86],[1445148985612,86],[1445148985852,86],[1445148988916,18],[1445148989163,18],[1445148989379,18],[1445148989972,18],[1445148990611,18],[1445148990795,18],[1445148990964,18],[1445148991139,18],[1445148991323,18],[1445148991524,18],[1445148991731,18],[1445148991923,18],[1445148992107,18],[1445148992915,18],[1445148993115,18],[1445148993283,18],[1445148993475,18],[1445148993651,18],[1445148993837,18],[1445148994307,18],[1445148994836,86],[1445148995212,86],[1445148995467,86],[1445148995723,86],[1445148995963,86],[1445148996267,86],[1445148997195,86],[1445148997459,86],[1445148997651,86],[1445148997835,86],[1445148998667,86],[1445148998875,86],[1445148999067,86],[1445148999259,86],[1445148999459,86],[1445148999675,86],[1445148999867,86],[1445149000083,86],[1445149000555,86],[1445149001164,86],[1445149001348,86],[1445149001563,86],[1445149001763,86],[1445149001955,86],[1445149003339,18],[1445149003547,18],[1445149003723,18],[1445149003891,18],[1445149004059,18],[1445149004275,18],[1445149004891,86],[1445149005427,86],[1445149005931,18],[1445149006130,18],[1445149006354,18],[1445149006971,86],[1445149007419,86],[1445149007875,18],[1445149008195,18],[1445149008443,18],[1445149008658,18],[1445149008811,86]];
      keys_pressed = [[1472289985255,72],[1472289985569,72],[1472289985808,72],[1472289986046,72],[1472289986280,72],[1472289986502,72],[1472289986726,72],[1472289986950,72],[1472289987166,72],[1472289987398,72],[1472289987623,72],[1472289987839,72],[1472289988038,72],[1472289988237,72],[1472289988438,72],[1472289988646,72],[1472289988837,72],[1472289989054,72],[1472289989253,72],[1472289989454,72],[1472289989657,72],[1472289989838,72],[1472289990036,72],[1472289990228,72],[1472289990429,72],[1472289990604,72],[1472289990780,72],[1472289990974,72],[1472289991285,72],[1472289991460,72],[1472289991653,72],[1472289992092,71],[1472289992308,71],[1472289992500,71],[1472289992715,71],[1472289992940,71],[1472289993195,72],[1472289993394,72],[1472289993588,72],[1472289993778,72],[1472289993964,72],[1472289994146,72],[1472289994339,72],[1472289994522,72],[1472289994706,72],[1472289994890,72],[1472289995067,72],[1472289995265,72],[1472289995483,72],[1472289995826,71],[1472289996570,71],[1472289996978,71],[1472289998770,86],[1472289999065,86],[1472289999299,86],[1472289999800,86],[1472290000087,86],[1472290000295,86],[1472290000488,86],[1472290000680,86],[1472290001280,86],[1472290001495,86],[1472290001662,86],[1472290002614,18],[1472290002862,18],[1472290003117,18],[1472290003309,18],[1472290003510,18],[1472290003717,18],[1472290003950,18],[1472290004165,18],[1472290005039,18],[1472290005764,86],[1472290006213,86],[1472290006428,86],[1472290006620,86],[1472290006853,86],[1472290007069,86],[1472290007732,86],[1472290007964,86],[1472290008268,86],[1472290008508,86],[1472290008756,86],[1472290009338,86],[1472290009563,86],[1472290009795,86],[1472290009986,86],[1472290010179,86],[1472290010339,86],[1472290010529,86],[1472290010700,86],[1472290011778,18],[1472290012002,18],[1472290012241,18],[1472290012449,18],[1472290012634,18],[1472290012850,18],[1472290013032,18],[1472290013240,18],[1472290013489,18],[1472290014112,86],[1472290014401,86],[1472290014633,86],[1472290014842,86],[1472290015040,86],[1472290016039,86],[1472290016320,86],[1472290016527,86],[1472290016719,86],[1472290017199,86],[1472290017438,86],[1472290017687,86],[1472290017920,86],[1472290018119,86],[1472290018327,86],[1472290018511,86],[1472290018710,86],[1472290018902,86],[1472290019110,86],[1472290019293,86],[1472290019902,18],[1472290020124,18],[1472290020349,18],[1472290020557,18],[1472290020772,18],[1472290020981,18],[1472290021413,18],[1472290021628,18],[1472290021829,18],[1472290022021,18],[1472290022179,18],[1472290022348,18],[1472290023053,86],[1472290023348,86],[1472290023587,86],[1472290023796,86],[1472290024003,86],[1472290024196,86],[1472290024396,86],[1472290024588,86],[1472290026250,18],[1472290026530,18],[1472290026802,18],[1472290027057,18],[1472290027290,18],[1472290027505,18],[1472290027770,18],[1472290027978,18],[1472290028177,18],[1472290028401,18],[1472290028609,18],[1472290028793,18],[1472290029488,18],[1472290029697,18],[1472290029905,18],[1472290030104,18],[1472290030320,18],[1472290030552,18],[1472290030768,18],[1472290030985,18],[1472290031224,18],[1472290031503,18],[1472290031808,18],[1472290032047,18],[1472290032280,18],[1472290032487,18],[1472290033264,18],[1472290033478,18],[1472290033742,18],[1472290033959,18],[1472290034246,18],[1472290034470,18],[1472290034678,18],[1472290034879,18],[1472290035086,18],[1472290035558,18],[1472290035806,18],[1472290036077,18],[1472290036317,18],[1472290036532,18],[1472290036765,18],[1472290036996,18],[1472290037213,18],[1472290037420,18],[1472290037653,18],[1472290037862,18],[1472290038053,18],[1472290038220,18],[1472290038436,18],[1472290038675,18],[1472290038883,18],[1472290039083,18],[1472290039283,18],[1472290040061,86],[1472290040331,86],[1472290040564,86],[1472290040812,86],[1472290041029,86],[1472290041204,86],[1472290041428,86],[1472290041619,86],[1472290041787,86],[1472290042291,18],[1472290042506,18],[1472290042723,18],[1472290042930,18],[1472290043130,18],[1472290043873,18],[1472290044081,18],[1472290044297,18],[1472290044521,18],[1472290044753,18],[1472290044970,18],[1472290045177,18],[1472290045392,18],[1472290045600,18],[1472290045824,18],[1472290046040,18],[1472290046240,18],[1472290046496,18],[1472290046712,18],[1472290046952,18],[1472290047184,18],[1472290047399,18],[1472290048142,18],[1472290048383,18],[1472290048615,18],[1472290049215,18],[1472290049447,18],[1472290049654,18],[1472290049847,18],[1472290050070,18],[1472290050277,18],[1472290050430,18],[1472290050742,18],[1472290050934,18],[1472290051150,18],[1472290051350,18],[1472290051574,18],[1472290051774,18],[1472290051982,18],[1472290052173,18],[1472290052372,18],[1472290053269,86],[1472290053517,86],[1472290053725,86],[1472290053934,86],[1472290054133,86],[1472290054356,86],[1472290054701,86],[1472290054909,86],[1472290055083,86],[1472290055269,86],[1472290055469,86],[1472290055652,86],[1472290056091,18],[1472290056307,18],[1472290056500,18],[1472290056700,18],[1472290056915,18],[1472290057139,18],[1472290057347,18],[1472290057547,18],[1472290057739,18],[1472290057931,18],[1472290058106,18],[1472290058273,18],[1472290058458,18],[1472290058634,18],[1472290059586,86],[1472290059802,86],[1472290060090,86],[1472290060306,86],[1472290060498,86],[1472290060678,86],[1472290060906,86],[1472290061106,86],[1472290061298,86],[1472290061680,86],[1472290061922,86],[1472290062113,86],[1472290062298,86],[1472290062504,86],[1472290062680,86],[1472290062873,86],[1472290063040,86],[1472290063969,86],[1472290064184,86],[1472290064368,86],[1472290064551,86],[1472290064760,86],[1472290064975,86],[1472290065167,86],[1472290065368,86],[1472290065558,86],[1472290065752,86],[1472290065952,86],[1472290066143,86],[1472290067230,18],[1472290067470,18],[1472290067718,18],[1472290067918,18],[1472290068134,18],[1472290068341,18],[1472290068541,18],[1472290068732,18],[1472290068940,18],[1472290069132,18],[1472290069317,18],[1472290069500,18],[1472290069693,18],[1472290070382,86],[1472290070636,86],[1472290070844,86],[1472290071085,86],[1472290071292,86],[1472290071515,86],[1472290071781,86],[1472290071987,86],[1472290072188,86],[1472290072388,86],[1472290072612,86],[1472290072861,86],[1472290073043,86],[1472290073236,86],[1472290073586,86],[1472290073892,86],[1472290074130,86],[1472290074331,86],[1472290074539,86],[1472290074738,86],[1472290074930,86],[1472290075147,86],[1472290075353,86],[1472290075577,86],[1472290075761,86],[1472290075955,86],[1472290076137,86],[1472290076322,86],[1472290076530,86],[1472290077088,18],[1472290077313,18],[1472290077505,18],[1472290077720,18],[1472290077937,18],[1472290078175,18],[1472290078392,18],[1472290078608,18],[1472290078815,18],[1472290079008,18],[1472290079240,18],[1472290079448,18],[1472290079648,18],[1472290079831,18],[1472290080023,18],[1472290080207,18],[1472290080382,18],[1472290081175,18],[1472290081382,18],[1472290081591,18],[1472290081791,18],[1472290081991,18],[1472290082182,18],[1472290082430,18],[1472290082622,18],[1472290082823,18],[1472290083006,18],[1472290083198,18],[1472290083389,18],[1472290083597,18],[1472290083814,18],[1472290083997,18],[1472290084158,18],[1472290084325,18],[1472290084565,18],[1472290084733,18],[1472290084925,18],[1472290085101,18],[1472290085284,18],[1472290085477,18],[1472290085692,18],[1472290086228,18],[1472290086444,18],[1472290086668,18],[1472290086892,18],[1472290087092,18],[1472290087291,18],[1472290087499,18],[1472290087724,18],[1472290087980,18],[1472290088195,18],[1472290088411,18],[1472290088643,18],[1472290088867,18],[1472290089083,18],[1472290089275,18],[1472290089459,18],[1472290089659,18],[1472290090282,18],[1472290090475,18],[1472290090995,86],[1472290091242,86],[1472290091498,86],[1472290091713,86],[1472290091898,86],[1472290092681,86],[1472290092922,86],[1472290093114,86],[1472290093329,86],[1472290093520,86],[1472290093729,86],[1472290093930,86],[1472290094128,86],[1472290094320,86],[1472290094504,86],[1472290094704,86],[1472290094913,86],[1472290095097,86],[1472290095824,18],[1472290096031,18],[1472290096231,18],[1472290096431,18],[1472290096639,18],[1472290096848,18],[1472290097030,18],[1472290097223,18],[1472290097407,18],[1472290097583,18],[1472290097758,18],[1472290097942,18],[1472290098174,18],[1472290098526,18],[1472290098742,18],[1472290098941,18],[1472290099118,18],[1472290100613,18],[1472290100821,18],[1472290101076,18],[1472290101309,18],[1472290101540,18],[1472290101757,18],[1472290102028,18],[1472290102316,18],[1472290102532,18],[1472290103124,18],[1472290103380,18],[1472290103612,18],[1472290103836,18],[1472290104043,18],[1472290104235,18],[1472290104419,18],[1472290104612,18],[1472290104883,18],[1472290105075,18],[1472290105259,18],[1472290105435,18],[1472290105635,18],[1472290106275,86],[1472290106530,86],[1472290106747,86],[1472290106963,86],[1472290107187,86],[1472290107402,86],[1472290107610,86],[1472290107810,86],[1472290108017,86],[1472290108210,86],[1472290108401,86],[1472290108617,86],[1472290108802,86],[1472290109018,86],[1472290109217,86],[1472290109890,86],[1472290110096,86],[1472290110272,86],[1472290110457,86],[1472290110656,86],[1472290110865,86],[1472290111057,86],[1472290111456,86],[1472290111687,86],[1472290111888,86],[1472290112072,86],[1472290112241,86],[1472290112945,86],[1472290113159,86],[1472290113408,86],[1472290113656,86],[1472290113862,86],[1472290114062,86],[1472290114415,86],[1472290114623,86],[1472290114815,86],[1472290115007,86],[1472290115199,86],[1472290115407,86],[1472290115622,86],[1472290115814,86],[1472290116021,86],[1472290116279,86],[1472290116522,86],[1472290116733,86],[1472290116910,86],[1472290117101,86],[1472290117293,86],[1472290117501,86],[1472290117686,86],[1472290117894,86],[1472290118084,86],[1472290119043,18],[1472290119267,18],[1472290119475,18],[1472290119651,18],[1472290119844,18],[1472290120019,18],[1472290120771,18],[1472290120978,18],[1472290121171,18],[1472290121355,18],[1472290121538,18],[1472290121731,18],[1472290121923,18],[1472290122122,18],[1472290122722,18],[1472290122977,18],[1472290123177,18],[1472290123370,18],[1472290123570,18],[1472290123754,18],[1472290123993,18],[1472290124217,18],[1472290124425,18],[1472290124617,18],[1472290124817,18],[1472290125032,18],[1472290125240,18],[1472290125449,18],[1472290125657,18],[1472290125873,18],[1472290126072,18],[1472290126248,18],[1472290126424,18],[1472290127273,18],[1472290127487,18],[1472290127711,18],[1472290127920,18],[1472290128111,18],[1472290128287,18],[1472290128479,18],[1472290128687,18],[1472290128895,18],[1472290129166,18],[1472290129407,18],[1472290129607,18],[1472290129815,18],[1472290130407,86],[1472290130663,86],[1472290130878,86],[1472290131087,86],[1472290131293,86],[1472290131502,86],[1472290131718,86],[1472290132038,86],[1472290132246,86],[1472290132414,86],[1472290132589,86],[1472290132766,86],[1472290132950,86],[1472290133150,86],[1472290133317,86],[1472290133670,86],[1472290134164,18],[1472290134332,18],[1472290134525,18],[1472290134724,18],[1472290134925,18],[1472290135123,18],[1472290135340,18],[1472290135764,18],[1472290135963,18],[1472290136147,18],[1472290136331,18],[1472290136523,18],[1472290136715,18],[1472290136891,18],[1472290137074,18],[1472290137260,18],[1472290137586,18],[1472290137835,18],[1472290138050,18],[1472290138258,18],[1472290138450,18],[1472290138642,18],[1472290138858,18],[1472290139066,18],[1472290139258,18],[1472290139450,18],[1472290139650,18],[1472290140321,18],[1472290140513,18],[1472290140705,18],[1472290140889,18],[1472290141081,18],[1472290141281,18],[1472290141473,18],[1472290141657,18],[1472290141832,18],[1472290142000,18],[1472290142176,18],[1472290142344,18],[1472290142537,18],[1472290143417,86],[1472290143689,86],[1472290143895,86],[1472290144104,86],[1472290144295,86],[1472290144479,86],[1472290144719,86],[1472290144929,86],[1472290145151,86],[1472290145383,86],[1472290145582,86],[1472290146135,86],[1472290146359,86],[1472290146582,86],[1472290146798,86],[1472290146983,86],[1472290147191,86],[1472290147374,86],[1472290148054,86],[1472290148246,86],[1472290148430,86],[1472290148637,86],[1472290148878,86],[1472290149093,86],[1472290149262,86],[1472290149454,86],[1472290149636,86],[1472290149828,86],[1472290150028,86],[1472290150332,86],[1472290151189,86],[1472290151396,86],[1472290151589,86],[1472290151803,86],[1472290152027,86],[1472290152212,86],[1472290152427,86],[1472290152637,86],[1472290152835,86],[1472290153034,86],[1472290153244,86],[1472290153435,86],[1472290153634,86],[1472290154226,18],[1472290154418,18],[1472290154635,18],[1472290154850,18],[1472290155049,18],[1472290155266,18],[1472290155450,18],[1472290156297,18],[1472290156529,18],[1472290156754,18],[1472290157001,18],[1472290158393,86],[1472290158633,86],[1472290158848,86],[1472290159047,86],[1472290159880,86],[1472290160072,86],[1472290160256,86],[1472290160464,86],[1472290160672,86],[1472290160896,86],[1472290161096,86],[1472290161344,86],[1472290161583,86],[1472290161822,86],[1472290162190,86],[1472290162510,86],[1472290162863,86],[1472290163279,86]];
      keys_pressed = JSON.stringify(keys_pressed);
      keys_pressed = JSON.parse(keys_pressed);

      for(index = 0; index < keys_pressed.length; index++) { 
 	  
    	  /* Initial Delay */
        delay = -3000;

    	  if(index > 0) {
    	    delay = keys_pressed[index][0] - keys_pressed[index-1][0];
    	  }
    	  global_time += delay;

        key = keys_pressed[index][1];

        /* 
        This is the best way to pass a variable to a Timeout function.
        1st argument is the function name. 
        2nd argument is the time.
        3rd argument is the parameter 
        Notice how keys_pressed[index][1] needs to be converted to one variable 'key'
        It's neater and probably the only way it works.
        */
    	  setTimeout(simulateKeyPress, global_time, key, keys_pressed[index][0]);

    	}
      // Finally, remove all speech bubbles for the end.
      $('.sb').css('display','none');	

    }
    
  });

  /* Volume Control */
  $('#volume_plus').click(function(){
    // Make it gradual plus
    episode1Sound.setVolume(100);
  });

  $('#volume_minus').click(function(){
    // Make it gradual minus
    episode1Sound.setVolume(10);
  });
  
  var canvas_tmp;
  
  /*
  // Get below working perhaps for next version of RD
  // or any other cartoon show (i.e Food Police).
  $('#zoom').click(function(){
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.translate(-300,-1500);
    ctx.scale(5,5);
    ctx.drawImage(canvas, 0, 0);
  });
 
  $('#wide').click(function(){
    // ALERT: Still not going back to WID, images missing.
    ctx.restore();
    // Clear Canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    cliff.charCommands(ctx, {'talk':[]});
    roy.charCommands(ctx, {'talk':[]});
  });
  */
  
});

$(document).keydown(function(e) {
	
	var d = new Date();
	
	if($('#record').val() != 'record') {
	  keys_pressed[i] =  new Array(d.getTime(), e.which);
  }

	i++;

  //alert(e.which);

  if($('#command_prompt').css('display') == 'block') {
    if($('#prompt').val().toLowerCase() == 'play the restless days 1'
       && commandPrompt.commandFound('play the restless days 1') 
       && e.which == 13) {

      $('#command_prompt').css('display','none');
      $('#gui').css('display','block');

      /* RECORD CODE: Comment out below line to Record. */
      $('#play_back').click();
    }
  }

  if($('#gui').css('display') == 'block') {
					
    switch(e.which) {
      case 27: // Escape key - Go back to Command Line
        $('#gui').css('display','none');
        $('#command_prompt').css('display','block');
        // ALERT: Sound BUGS WILL BE ANNOYING!!!! Watch out!!!!
        episode1Sound.pause();
        break;
      case 37: // left arrow - Char1 left
      	//alert('left');
      	cliff.charCommands(ctx, {'move':["'left'"]});
        break;

      case 38: // up arrow - Char1 up
      	// if(!isPixelCollision(phil.img, phil.x + 20, phil.y + 20, mimi.img, mimi.x, mimi.y, false)) {
        cliff.charCommands(ctx, {'move':["'up'"]});
      	// }
      	break;

      case 39: // right arrow - Char1 right
      	// Collision Detection
      	// if(!isPixelCollision(phil.img, phil.x + 20, phil.y + 20, mimi.img, mimi.x, mimi.y, false)) {
        cliff.charCommands(ctx, {'move':["'right'"]});	
      	// }
      	break;

      case 40: // down arrow - Char1 down
        cliff.charCommands(ctx, {'move':["'down'"]});
      	break;
      
      case 18: // space key - Char1 talk
        cliff.charCommands(ctx, {'talk':[]});
          break;
      
      case 191: // / ? key - Char1s sit
        cliff.charCommands(ctx, {'sit':[]});
      	break;
      
      case 9: // TAB key - Char2 talk
      	mimi.charCommands(ctx, {'talk':[]});
      	break;
      
      case 87: // w key - Char2 up
      	mimi.charCommands(ctx, {'move':["'up'"]});
      	break;
      
      case 83: // s key - Char2 down
      	mimi.charCommands(ctx, {'move':["'down'"]});
        break;
      
      case 65: // a key - Char2 left
      	mimi.charCommands(ctx, {'move':["'left'"]});
        break;
      
      case 68: // d key - Char2 right
      	mimi.charCommands(ctx, {'move':["'right'"]});
        break;
      
      case 20: // Caps Lock key - Char2 sit
      	mimi.charCommands(ctx, {'sit':[]});
        break;

      case 89: // y key - Char2 up
        roy.charCommands(ctx, {'move':["'up'"]});
        break;
      
      case 72: // h key - Char2 down
        roy.charCommands(ctx, {'move':["'down'"]});
        break;

      case 71: // g key - Char2 left
        roy.charCommands(ctx, {'move':["'left'"]});
        break;
      
      case 74: // j key - Char2 right
        roy.charCommands(ctx, {'move':["'right'"]});
        break;

      case 86: // v key - Char2 talk
        roy.charCommands(ctx, {'talk':[]});
        break;

      case 66: // b key - Char2 sit
        roy.charCommands(ctx, {'sit':[]});
        break;

      default: return; // exit this handler for other keys
    }
    e.preventDefault(); // prevent the default action (scroll / move caret)

  }
    
});

function doMouseDown(event){
  x = event.pageX - canvas.offsetLeft;
  y = event.pageY - canvas.offsetTop;
  alert(x + ':' + y);
  //ctx.translate(x,y);
}

/**
 * @author Joseph Lenton - PlayMyCode.com
 *
 * @param first An ImageData character from the first image we are colliding with.
 * @param x The x location of 'first'.
 * @param y The y location of 'first'.
 * @param other An ImageData character from the second image involved in the collision check.
 * @param x2 The x location of 'other'.
 * @param y2 The y location of 'other'.
 * @param isCentred True if the locations refer to the centre of 'first' and 'other', false to specify the top left corner.
 */
function isPixelCollision( first, x, y, other, x2, y2, isCentred )
{
    // we need to avoid using floats, as were doing array lookups
    x  = Math.round( x );
    y  = Math.round( y );
    x2 = Math.round( x2 );
    y2 = Math.round( y2 );

    var w  = first.width,
        h  = first.height,
        w2 = other.width,
        h2 = other.height ;

    // deal with the image being centred
    if ( isCentred ) {
        // fast rounding, but positive only
        x  -= ( w/2 + 0.5) << 0
        y  -= ( h/2 + 0.5) << 0
        x2 -= (w2/2 + 0.5) << 0
        y2 -= (h2/2 + 0.5) << 0
    }

    // find the top left and bottom right corners of overlapping area
    var xMin = Math.max( x, x2 ),
        yMin = Math.max( y, y2 ),
        xMax = Math.min( x+w, x2+w2 ),
        yMax = Math.min( y+h, y2+h2 );

    // Sanity collision check, we ensure that the top-left corner is both
    // above and to the left of the bottom-right corner.
    if ( xMin >= xMax || yMin >= yMax ) {
        return false;
    }

    var xDiff = xMax - xMin,
        yDiff = yMax - yMin;

    // get the pixels out from the images
    var pixels  = first.data,
        pixels2 = other.data;

    // if the area is really small,
    // then just perform a normal image collision check
    if ( xDiff < 4 && yDiff < 4 ) {    	
        for ( var pixelX = xMin; pixelX < xMax; pixelX++ ) {
            for ( var pixelY = yMin; pixelY < yMax; pixelY++ ) {
                if (
                        ( pixels [ ((pixelX-x ) + (pixelY-y )*w )*4 + 3 ] !== 0 ) &&
                        ( pixels2[ ((pixelX-x2) + (pixelY-y2)*w2)*4 + 3 ] !== 0 )
                ) {
                	alert('true');
                    return 'true';
                }
            }
        }
    } else {
        /* What is this doing?
         * It is iterating over the overlapping area,
         * across the x then y the,
         * checking if the pixels are on top of this.
         *
         * What is special is that it increments by incX or incY,
         * allowing it to quickly jump across the image in large increments
         * rather then slowly going pixel by pixel.
         *
         * This makes it more likely to find a colliding pixel early.
         */

        // Work out the increments,
        // it's a third, but ensure we don't get a tiny
        // slither of an area for the last iteration (using fast ceil).
        var incX = xDiff / 3.0,
            incY = yDiff / 3.0;
        incX = (~~incX === incX) ? incX : (incX+1 | 0);
        incY = (~~incY === incY) ? incY : (incY+1 | 0);
        
        for ( var offsetY = 0; offsetY < incY; offsetY++ ) {
            for ( var offsetX = 0; offsetX < incX; offsetX++ ) {
                for ( var pixelY = yMin+offsetY; pixelY < yMax; pixelY += incY ) {
                    for ( var pixelX = xMin+offsetX; pixelX < xMax; pixelX += incX ) {
                    	return true;
                    	/*
                    	if (
                                ( pixels [ ((pixelX-x ) + (pixelY-y )*w )*4 + 3 ] !== 0 ) &&
                                ( pixels2[ ((pixelX-x2) + (pixelY-y2)*w2)*4 + 3 ] !== 0 )
                        ) {
                        	return 'true';
                        }
                        */
                    }
                }
            }
        }
        
    }

    return false;
}